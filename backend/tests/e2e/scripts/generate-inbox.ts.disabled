/**
 * Generate Inbox Script
 *
 * Generate and save a realistic inbox for testing
 *
 * Usage:
 *   npx ts-node tests/e2e/scripts/generate-inbox.ts [role] [outputFile]
 *
 * Examples:
 *   npx ts-node tests/e2e/scripts/generate-inbox.ts executive
 *   npx ts-node tests/e2e/scripts/generate-inbox.ts manager my-test-inbox.json
 */

import * as fs from 'fs';
import * as path from 'path';
import { GenericAIService } from '../../../src/services/generic-ai.service';
import { AIDomainService } from '../../../src/services/domain/ai-domain.service';
import { WholeInboxGenerator, InboxData } from '../generators/whole-inbox-generator';

async function main() {
  const args = process.argv.slice(2);

  if (args[0] === '--help' || args[0] === '-h') {
    console.log('Generate Inbox - Create realistic test inboxes with AI');
    console.log('');
    console.log('Usage: npm run e2e:generate-inbox [role] [outputFile]');
    console.log('');
    console.log('Roles:');
    console.log('  quick-test    20 emails (2-3 min, ~$0.10) - Fast testing');
    console.log('  individual    40 emails (5-8 min, ~$0.20) - Individual contributor');
    console.log('  manager       60 emails (8-12 min, ~$0.30) - Manager');
    console.log('  executive    100 emails (12-18 min, ~$0.50) - Executive');
    console.log('  mixed         80 emails (10-15 min, ~$0.40) - Mixed role');
    console.log('');
    console.log('Examples:');
    console.log('  npm run e2e:generate-inbox quick-test');
    console.log('  npm run e2e:generate-inbox executive my-inbox.json');
    console.log('');
    console.log('Note: All emails include full, realistic bodies (200-500 words each)');
    console.log('      Generation uses OpenAI GPT-5 for maximum realism');
    process.exit(0);
  }

  const role = (args[0] || 'quick-test') as 'executive' | 'manager' | 'individual' | 'mixed' | 'quick-test';
  const outputFile = args[1] || `inbox-${role}-${Date.now()}.json`;

  console.log('üöÄ Generating realistic inbox with AI...');
  console.log(`   Role: ${role}`);
  console.log(`   Output: ${outputFile}`);
  console.log('');
  console.log('‚è∞ Time estimates:');
  const estimates: Record<string, string> = {
    'quick-test': '2-3 minutes (~20 emails with full bodies)',
    'individual': '5-8 minutes (~40 emails with full bodies)',
    'manager': '8-12 minutes (~60 emails with full bodies)',
    'executive': '12-18 minutes (~100 emails with full bodies)',
    'mixed': '10-15 minutes (~80 emails with full bodies)'
  };
  console.log(`   ${estimates[role] || 'Unknown'}`);
  console.log('');

  try {
    // Initialize services
    console.log('‚öôÔ∏è  Initializing AI services...');
    const aiDomainService = new AIDomainService();
    await aiDomainService.initialize();

    const aiService = new GenericAIService(aiDomainService);
    await aiService.initialize();

    const inboxGenerator = new WholeInboxGenerator(aiService);
    await inboxGenerator.initialize();

    // Get template for role
    console.log(`üìã Loading ${role} template...`);
    const template = inboxGenerator.getTemplate(role);
    if (!template) {
      throw new Error(`Unknown role: ${role}. Valid roles: quick-test, executive, manager, individual, mixed`);
    }

    // Generate inbox
    console.log(`üìß Generating ${template.emailCount} emails with full realistic bodies...`);
    console.log('   Each email will have 200-500 words of content');
    console.log('   Generating in batches of 8 for maximum quality...');
    console.log('');

    const startTime = Date.now();
    const inboxData = await inboxGenerator.generateCompleteInbox(template);
    const duration = ((Date.now() - startTime) / 1000).toFixed(2);

    // Save to file
    const outputDir = path.join(__dirname, '../data/generated-inboxes');
    if (!fs.existsSync(outputDir)) {
      fs.mkdirSync(outputDir, { recursive: true });
    }

    const outputPath = path.join(outputDir, outputFile);
    fs.writeFileSync(outputPath, JSON.stringify(inboxData, null, 2));

    // Print summary
    console.log('‚úÖ Inbox generated successfully!');
    console.log('');
    console.log('üìä Summary:');
    console.log(`   Role: ${inboxData.metadata.userProfile.role}`);
    console.log(`   Industry: ${inboxData.metadata.userProfile.industry}`);
    console.log(`   Total Emails: ${inboxData.emails.length}`);
    console.log(`   Calendar Events: ${inboxData.calendar.length}`);
    console.log(`   Relationships: ${inboxData.relationships.length}`);
    console.log(`   Generation Time: ${duration}s`);
    console.log('');
    console.log(`üìÅ Saved to: ${outputPath}`);
    console.log('');
    console.log('üí° Usage:');
    console.log(`   npx ts-node tests/e2e/scripts/test-command.ts "${outputPath}" "Show me urgent emails"`);
    console.log('');

    // Print sample emails
    console.log('üì¨ Sample Emails (first 5):');
    inboxData.emails.slice(0, 5).forEach((email, index) => {
      const subject = email.payload.headers.find(h => h.name === 'Subject')?.value || 'No subject';
      const from = email.payload.headers.find(h => h.name === 'From')?.value || 'Unknown';
      const labels = email.labelIds.join(', ');

      console.log(`\n   ${index + 1}. ${subject}`);
      console.log(`      From: ${from}`);
      console.log(`      Labels: ${labels}`);
      console.log(`      Snippet: ${email.snippet.substring(0, 80)}...`);
    });

    process.exit(0);
  } catch (error: any) {
    console.error('‚ùå Error generating inbox:', error.message);
    console.error(error.stack);
    process.exit(1);
  }
}

main();
